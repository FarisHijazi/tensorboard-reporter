#!/usr/bin/env python3

import argparse
from datetime import datetime, timedelta
import time

from tbr.loader import load_summaries
from tbr.summary import tag, wall_time_in_range
from tbr.stats import current_mean


parser = argparse.ArgumentParser(
    description="Get reports for your training process via Slack"
)
parser.add_argument("run_dir", type=str, help="tensorboard run dir")
parser.add_argument("tag", type=str, help="tag to report")
parser.add_argument("interval_hour", type=int, help="report interval hour")

args = parser.parse_args()

while True:
    time.sleep(args.interval_hour * 60 * 60)

    summaries = load_summaries(args.run_dir)
    summaries = filter(tag(args.tag), summaries)
    summaries = filter(
        wall_time_in_range(
            min=datetime.now() - timedelta(hours=args.interval_hour), max=None
        ),
        summaries,
    )
    summaries = list(summaries)

    mean = current_mean(summaries)
    if mean is None:
        print(f"no data found for last {args.interval_hour} hours")
    else:
        print(f"current mean for last {args.interval_hour} hours -> {mean}")
